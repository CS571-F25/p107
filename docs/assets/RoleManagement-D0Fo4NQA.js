import{j as e,b as P,A as O,R as w,c,a as b,C,F as x,h as J,B as $,D as j,M as f}from"./vendor-bootstrap-C6xIMti8.js";import{r as t}from"./vendor-router-DArSVHJ3.js";import{b as D,c as T}from"./vendor-firebase-CYcY3q11.js";import{u as K}from"./blog-CaqybC2x.js";import{c as Q,i as X,l as Z}from"./index-Dr8r4x_O.js";import{d as G,a as R,f as ee,j as se}from"./auth-Sw-QPVcd.js";import"./vendor-react-Bzgz95E1.js";function ce(){const[N,y]=t.useState([]),[V,_]=t.useState(!0),[S,o]=t.useState(""),[k,d]=t.useState(""),[u,M]=t.useState(null),[v,F]=t.useState("unverified_user"),[W,g]=t.useState(!1),[L,A]=t.useState(!1),{level:H,isOwner:E}=K(),I=Z(H),U=Q(I),p=U&&!X(I);t.useEffect(()=>{h()},[]);const h=async()=>{try{_(!0);const s=await D(T(G,"userRoles")),r={};s.forEach(l=>{const a=l.data();r[a.userId]||(r[a.userId]=[]),r[a.userId].push(a.roleId)});let n={};try{(await D(T(G,"userInfo"))).forEach(a=>{const m=a.data();n[a.id]=m})}catch(l){console.warn("Could not load userInfo collection:",l)}const i=Object.entries(r).map(([l,a])=>{const m=n[l];return{id:l,email:m?.email||(l===R.currentUser?.uid?R.currentUser?.email:l),nickname:m?.nickname||m?.email?.split("@")[0]||l.slice(0,8),roles:a,isCurrentUser:l===R.currentUser?.uid}});y(i)}catch(s){o(`Failed to load users: ${s.message}`),console.error("Error fetching users:",s)}finally{_(!1)}},Y=async()=>{if(u)try{if(o(""),d(""),u.isCurrentUser&&v!=="owner"){o("You cannot change your own role from Owner");return}await ee(u.id,v,R.currentUser?.uid),d(`Successfully changed ${u.email}'s role to ${v}`),g(!1),M(null),setTimeout(h,1e3)}catch(s){o(`Failed to change role: ${s.message}`)}},q=async()=>{try{A(!0),o(""),d("");const s=await se();d(`Successfully cleaned up ${s} duplicate roles`),await h()}catch(s){o(`Failed to cleanup roles: ${s.message}`)}finally{A(!1)}},z=(s,r)=>{const n={owner:"danger",admin:"warning",verified_user:"success",unverified_user:"info",guest:"light"},i={owner:"Owner",admin:"Admin",verified_user:"Verified User",unverified_user:"Unverified User",guest:"Guest"};return e.jsx($,{bg:n[s]||"secondary",className:"me-1",children:i[s]||s},r)};if(V)return e.jsx("div",{className:"text-center p-4",children:"Loading users..."});const B={};return e.jsxs(P,{fluid:!0,style:{maxWidth:"1400px",padding:"2rem 1rem"},children:[S&&e.jsx(O,{variant:"danger",onClose:()=>o(""),dismissible:!0,children:S}),k&&e.jsx(O,{variant:"success",onClose:()=>d(""),dismissible:!0,children:k}),e.jsx(w,{className:"mb-4",children:e.jsx(c,{children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"mb-1",children:"Role Management"}),e.jsx("p",{className:"text-muted mb-0",children:"Manage user roles and related actions"})]}),e.jsx(b,{variant:"primary",onClick:q,disabled:L,children:L?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-1"}),"Cleaning..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"bi bi-arrow-clockwise me-2"}),"Cleanup Roles"]})})]})})}),e.jsx(w,{className:"mb-4",children:e.jsx(c,{children:e.jsx(C,{style:B,children:e.jsx(C.Body,{children:e.jsxs(w,{className:"g-3",children:[e.jsx(c,{md:3,children:e.jsxs(x.Select,{onChange:s=>{const r=s.target.value;r==="all"?h():y(n=>n.filter(i=>(i.roles||[]).includes(r)))},defaultValue:"all",children:[e.jsx("option",{value:"all",children:"All Roles"}),e.jsx("option",{value:"owner",children:"Owner"}),e.jsx("option",{value:"admin",children:"Admin"}),e.jsx("option",{value:"verified_user",children:"Verified User"}),e.jsx("option",{value:"unverified_user",children:"Unverified User"}),e.jsx("option",{value:"guest",children:"Guest"})]})}),e.jsx(c,{md:3,children:e.jsx(x.Control,{type:"text",placeholder:"Search by email",onChange:s=>{const r=s.target.value.trim().toLowerCase();if(!r){h();return}y(n=>n.filter(i=>(i.email||"").toLowerCase().includes(r)))}})}),e.jsx(c,{md:6})]})})})})}),e.jsx(w,{children:e.jsx(c,{children:e.jsx(C,{style:B,children:e.jsx(C.Body,{children:e.jsxs(J,{responsive:!0,hover:!0,className:"mb-0",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"User"}),e.jsx("th",{children:"Current Roles"}),U&&e.jsx("th",{style:{width:"160px"},className:"text-end",children:"Actions"})]})}),e.jsx("tbody",{children:N.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:"3",className:"text-center text-muted",children:"No users with roles found"})}):N.map(s=>e.jsxs("tr",{children:[e.jsxs("td",{children:[e.jsxs("div",{children:[e.jsx("strong",{children:s.email}),s.nickname&&s.nickname!==s.email?.split("@")[0]&&e.jsx("div",{children:e.jsxs("small",{className:"text-muted",children:["(",s.nickname,")"]})}),e.jsx("div",{children:e.jsxs("small",{className:"text-muted font-monospace",children:["ID: ",s.id]})})]}),s.isCurrentUser&&e.jsx($,{bg:"primary",className:"ms-2",children:"You"})]}),e.jsx("td",{children:s.roles.map((r,n)=>z(r,n))}),U&&e.jsx("td",{className:"text-end",children:e.jsxs(j,{children:[e.jsx(j.Toggle,{variant:"outline-secondary",size:"sm",disabled:p&&(s.roles||[]).includes("owner"),children:"Actions"}),e.jsxs(j.Menu,{align:"end",children:[e.jsx(j.Item,{onClick:()=>{const r=E?["verified_user","unverified_user","admin","owner"]:p?["verified_user","unverified_user","guest"]:["verified_user","unverified_user","admin","owner"],n=s.roles&&s.roles[0]||"unverified_user",i=r.includes(n)?n:r[0];M(s),F(i),g(!0)},disabled:s.isCurrentUser||p&&(s.roles||[]).includes("owner"),children:"Change Role"}),e.jsx(j.Item,{disabled:!0,className:s.isCurrentUser?"":"d-none",children:"Current User"})]})]})})]},s.id))})]})})})})}),e.jsxs(f,{show:W,onHide:()=>g(!1),children:[e.jsx(f.Header,{closeButton:!0,children:e.jsx(f.Title,{children:"Change User Role"})}),e.jsxs(f.Body,{children:[e.jsxs("p",{children:["Change role for: ",e.jsx("strong",{children:u?.email})]}),e.jsx("p",{className:"text-muted small",children:"Users must have exactly one role. Changing the role will replace the current role."}),e.jsxs(x.Group,{children:[e.jsx(x.Label,{children:"New Role"}),e.jsx(x.Select,{value:v,onChange:s=>F(s.target.value),children:(()=>{const s={owner:"Owner (Level 0) - Full system access",admin:"Admin (Level 1) - Can manage articles",verified_user:"Verified User (Level 2) - Can comment and like",unverified_user:"Unverified User (Level 3) - Can only read and like",guest:"Guest"};return(E?["verified_user","unverified_user","admin","owner"]:p?["verified_user","unverified_user","guest"]:["verified_user","unverified_user","admin","owner"]).map(n=>e.jsx("option",{value:n,children:s[n]||n},n))})()})]})]}),e.jsxs(f.Footer,{children:[e.jsx(b,{variant:"secondary",onClick:()=>g(!1),children:"Cancel"}),e.jsx(b,{variant:"primary",onClick:Y,children:"Update Role"})]})]})]})}export{ce as default};
