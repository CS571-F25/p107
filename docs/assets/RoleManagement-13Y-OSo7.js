import{j as e,A as N,a as x,h as A,B as k,M as d,F as g}from"./vendor-bootstrap-D2eqalZl.js";import{r as a}from"./vendor-router-CUyV5JBb.js";import{b as E,c as F}from"./vendor-firebase-CYcY3q11.js";import{d as M,a as j,f as D,j as T}from"./auth-DdQ2LLef.js";import"./vendor-react-Bzgz95E1.js";function Y(){const[v,_]=a.useState([]),[I,w]=a.useState(!0),[C,l]=a.useState(""),[y,u]=a.useState(""),[i,U]=a.useState(null),[h,R]=a.useState("unverified_user"),[L,m]=a.useState(!1),[b,S]=a.useState(!1);a.useEffect(()=>{f()},[]);const f=async()=>{try{w(!0);const s=await E(F(M,"userRoles")),t={};s.forEach(r=>{const n=r.data();t[n.userId]||(t[n.userId]=[]),t[n.userId].push(n.roleId)});let c={};try{(await E(F(M,"userInfo"))).forEach(n=>{const o=n.data();c[n.id]=o})}catch(r){console.warn("Could not load userInfo collection:",r)}const p=Object.entries(t).map(([r,n])=>{const o=c[r];return{id:r,email:o?.email||(r===j.currentUser?.uid?j.currentUser?.email:r),nickname:o?.nickname||o?.email?.split("@")[0]||r.slice(0,8),roles:n,isCurrentUser:r===j.currentUser?.uid}});_(p)}catch(s){l(`Failed to load users: ${s.message}`),console.error("Error fetching users:",s)}finally{w(!1)}},B=async()=>{if(i)try{if(l(""),u(""),i.isCurrentUser&&h!=="owner"){l("You cannot change your own role from Owner");return}await D(i.id,h,j.currentUser?.uid),u(`Successfully changed ${i.email}'s role to ${h}`),m(!1),U(null),setTimeout(f,1e3)}catch(s){l(`Failed to change role: ${s.message}`)}},O=async()=>{try{S(!0),l(""),u("");const s=await T();u(`Successfully cleaned up ${s} duplicate roles`),await f()}catch(s){l(`Failed to cleanup roles: ${s.message}`)}finally{S(!1)}},$=(s,t)=>{const c={owner:"danger",admin:"warning",verified_user:"success",unverified_user:"info",guest:"light"},p={owner:"Owner",admin:"Admin",verified_user:"Verified User",unverified_user:"Unverified User",guest:"Guest"};return e.jsx(k,{bg:c[s]||"secondary",className:"me-1",children:p[s]||s},t)};return I?e.jsx("div",{className:"text-center p-4",children:"Loading users..."}):e.jsxs("div",{children:[C&&e.jsx(N,{variant:"danger",children:C}),y&&e.jsx(N,{variant:"success",children:y}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsx("h5",{children:"User Role Management"}),e.jsxs("div",{children:[e.jsx(x,{variant:"outline-warning",size:"sm",onClick:O,disabled:b,className:"me-2",children:b?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-1"}),"Cleaning..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"bi bi-arrow-clockwise me-1"}),"Cleanup Roles"]})}),e.jsx("small",{className:"text-muted",children:"Only Owner can change user roles â€¢ Every user must have exactly one role"})]})]}),e.jsxs(A,{striped:!0,bordered:!0,hover:!0,responsive:!0,children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"User"}),e.jsx("th",{children:"Current Roles"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:v.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:"3",className:"text-center text-muted",children:"No users with roles found"})}):v.map(s=>e.jsxs("tr",{children:[e.jsxs("td",{children:[e.jsxs("div",{children:[e.jsx("strong",{children:s.email}),s.nickname&&s.nickname!==s.email?.split("@")[0]&&e.jsx("div",{children:e.jsxs("small",{className:"text-muted",children:["(",s.nickname,")"]})}),e.jsx("div",{children:e.jsxs("small",{className:"text-muted font-monospace",children:["ID: ",s.id]})})]}),s.isCurrentUser&&e.jsx(k,{bg:"primary",className:"ms-2",children:"You"})]}),e.jsx("td",{children:s.roles.map((t,c)=>$(t,c))}),e.jsx("td",{children:e.jsx(x,{variant:"outline-primary",size:"sm",onClick:()=>{U(s),R(s.roles[0]||"unverified_user"),m(!0)},disabled:s.isCurrentUser,children:s.isCurrentUser?"Current User":"Change Role"})})]},s.id))})]}),e.jsxs(d,{show:L,onHide:()=>m(!1),children:[e.jsx(d.Header,{closeButton:!0,children:e.jsx(d.Title,{children:"Change User Role"})}),e.jsxs(d.Body,{children:[e.jsxs("p",{children:["Change role for: ",e.jsx("strong",{children:i?.email})]}),e.jsx("p",{className:"text-muted small",children:"Users must have exactly one role. Changing the role will replace the current role."}),e.jsxs(g.Group,{children:[e.jsx(g.Label,{children:"New Role"}),e.jsxs(g.Select,{value:h,onChange:s=>R(s.target.value),children:[e.jsx("option",{value:"verified_user",children:"Verified User (Level 2) - Can comment and like"}),e.jsx("option",{value:"unverified_user",children:"Unverified User (Level 3) - Can only read and like"}),e.jsx("option",{value:"admin",children:"Admin (Level 1) - Can manage articles"}),i?.isCurrentUser&&e.jsx("option",{value:"owner",children:"Owner (Level 0) - Full system access"})]})]})]}),e.jsxs(d.Footer,{children:[e.jsx(x,{variant:"secondary",onClick:()=>m(!1),children:"Cancel"}),e.jsx(x,{variant:"primary",onClick:B,children:"Update Role"})]})]})]})}export{Y as default};
