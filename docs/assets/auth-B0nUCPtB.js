import{i as F,g as V,a as q,b as L,c as R,d as P,e as j,q as D,w as N,f as O,s as I,h as k,j as B,k as z,l as G,m as W,u as K,n as Y,o as H}from"./vendor-firebase-CYcY3q11.js";import{j as o}from"./vendor-bootstrap-BjNfiZWK.js";import{r as a,u as U,L as x,a as J}from"./vendor-router-CUyV5JBb.js";const A=a.createContext(null),Q={apiKey:"AIzaSyCuyUsRMqyWadJGoQMx30ksAMFMG9U1j1A",authDomain:"orientingway.firebaseapp.com",projectId:"orientingway",storageBucket:"orientingway.firebasestorage.app",messagingSenderId:"321906289343",appId:"1:321906289343:web:9365f767c4b48eb522740a"},T=F(Q),y=V(T),w=q(T),$="roles",S="userRoles",X="auditLogs",f={OWNER:0,ADMIN:1,VERIFIED_USER:2,UNVERIFIED_USER:3,GUEST:4},he=async()=>{try{if(!y.currentUser)throw new Error("You must be logged in to initialize roles");const s=[{id:"owner",name:"Owner",level:f.OWNER,description:"System owner with full permissions",permissions:["*"]},{id:"admin",name:"Admin",level:f.ADMIN,description:"Site administrator",permissions:["blog:read-all","blog:write-all","blog:publish-all","blog:delete-all","user:manage","view:all-posts"]},{id:"verified_user",name:"Verified User",level:f.VERIFIED_USER,description:"Email verified user with full user privileges",permissions:["blog:read-published","blog:like","blog:comment"]},{id:"unverified_user",name:"Unverified User",level:f.UNVERIFIED_USER,description:"Unverified user with limited privileges",permissions:["blog:read-published","blog:like"]},{id:"guest",name:"Guest",level:f.GUEST,description:"Anonymous user",permissions:["blog:read-published"]}];console.log("Starting role initialization...");const e=[];for(const t of s)try{console.log(`Creating role: ${t.id}`);const r=j(w,$,t.id);(await O(r)).exists()&&console.log(`Role ${t.id} already exists, updating...`),await I(r,{...t,createdAt:k(),updatedAt:k()},{merge:!0}),e.push(t.id),console.log(`‚úì Role ${t.id} created/updated successfully`)}catch(r){throw console.error(`Failed to create role ${t.id}:`,r),new Error(`Failed to create role ${t.id}: ${r.message}`)}return console.log("All roles initialized successfully:",e),e}catch(s){throw console.error("Error initializing roles:",s),s.code==="permission-denied"?new Error("Permission denied. Please check your Firestore security rules. You may need to update them to allow role creation. See FIRESTORE_PERMISSIONS_GUIDE.md for help."):s.code==="unavailable"?new Error("Firestore is currently unavailable. Please check your internet connection and try again."):s.message.includes("auth")?new Error("Authentication error. Please make sure you are logged in."):s}},b=async s=>{try{const e=D(R(w,S),N("userId","==",s)),t=await L(e),r=[];return t.forEach(l=>{r.push({id:l.id,...l.data()})}),(await Promise.all(r.map(async l=>{const d=await O(j(w,$,l.roleId));return{...l,role:d.exists()?d.data():null}}))).filter(l=>l.role!==null)}catch(e){throw console.error("Error getting user roles:",e),e}},M=async(s,e,t)=>{try{const r=j(R(w,S));return await I(r,{userId:s,roleId:e,assignedBy:t,assignedAt:k()}),await re({actorId:t,action:"role:assign",entityType:"user",entityId:s,meta:{roleId:e}}),console.log(`‚úÖ Assigned role ${e} to user ${s}`),r.id}catch(r){throw console.error("Error assigning role:",r),r}},Z=async(s,e,t)=>{try{return await ee(s),await M(s,e,t)}catch(r){throw console.error("Error assigning exclusive role:",r),r}},ee=async s=>{try{const e=D(R(w,S),N("userId","==",s)),t=await L(e),r=[];t.forEach(n=>{r.push(P(n.ref))}),await Promise.all(r),console.log(`üóëÔ∏è Removed ${r.length} existing roles for user ${s}`)}catch(e){throw console.error("Error removing user roles:",e),e}},fe=async(s,e)=>{try{if(console.log("üîç hasPermission called:",{userId:s,permission:e}),!s){const r=e==="blog:read-published";return console.log("üîç Guest user permission check:",{permission:e,allowed:r}),r}console.log("üîç Getting user roles for authenticated user...");const t=await b(s);for(const r of t){const n=r.role;if(n){if(n.permissions.includes("*"))return console.log("‚úÖ User has owner permissions"),!0;if(n.permissions.includes(e))return console.log("‚úÖ User has specific permission:",e),!0}}return console.log("‚ùå User does not have permission:",e),!1}catch(t){return console.error("Error checking permission:",t),!1}},_=async s=>{try{if(!s)return f.GUEST;const e=await b(s);if(e.length===0)return console.log("üö® No roles found for user, but NOT auto-assigning during getUserLevel to avoid conflicts"),f.UNVERIFIED_USER;const t=e.filter(r=>r.role&&typeof r.role.level=="number").map(r=>r.role.level);return t.length===0?f.UNVERIFIED_USER:(console.log("üîç getUserLevel Debug:",{userId:s,userRoles:e.map(r=>({roleId:r.roleId,level:r.role?.level,name:r.role?.name})),validLevels:t,minLevel:Math.min(...t)}),Math.min(...t))}catch(e){return console.error("Error getting user level:",e),f.UNVERIFIED_USER}},pe=async s=>{try{const e=await _(s),t=e<=f.ADMIN;return console.log("üîç canAccessAdmin Debug:",{userId:s,level:e,hasAdmin:t,threshold:f.ADMIN}),t}catch(e){return console.error("Error checking admin access:",e),!1}},ye=async s=>{try{return await _(s)<=f.ADMIN}catch(e){return console.error("Error checking content management:",e),!1}},we=async s=>{try{const e=await b(s),t=e.some(r=>r.role&&(r.role.level===f.OWNER||r.roleId==="owner"));return console.log("üîç isOwner Debug:",{userId:s,hasOwnerRole:t,userRoles:e.map(r=>r.roleId)}),t}catch(e){return console.error("Error checking owner status:",e),!1}},re=async({actorId:s,action:e,entityType:t,entityId:r,meta:n={}})=>{try{await I(j(R(w,X)),{actorId:s,action:e,entityType:t,entityId:r,meta:n,timestamp:k()})}catch(l){console.error("Error logging action:",l)}},ve=async s=>{try{if((await b(s)).length>0)return;const r=y.currentUser?.emailVerified||!1,n=r?"verified_user":"unverified_user";console.log(`üîÑ Auto-assigning role: ${n} (emailVerified: ${r})`),await M(s,n,"system")}catch(e){console.error("Error assigning default role:",e)}},xe=async()=>{try{const s=y.currentUser?.uid;if(!s)throw new Error("No authenticated user");console.log("üîÑ Starting exclusive owner assignment for user:",s);const e=await b(s);console.log("üìã Current roles before assignment:",e.map(n=>n.roleId)),await Z(s,"owner",s);const t=await b(s);console.log("üìã New roles after assignment:",t.map(n=>n.roleId));const r=await _(s);return console.log("üî¢ New user level:",r),console.log("‚úÖ Successfully made current user the exclusive owner"),!0}catch(s){throw console.error("‚ùå Error making current user owner:",s),s}},Ee=async()=>{try{console.log("üßπ Starting comprehensive role cleanup...");const s=await L(R(w,S)),e={};s.forEach(r=>{const n=r.data();e[n.userId]||(e[n.userId]=[]),e[n.userId].push({id:r.id,...n})});let t=0;for(const[r,n]of Object.entries(e))if(n.length>1){console.log(`üßπ User ${r} has ${n.length} roles:`,n.map(i=>i.roleId));const l={};n.forEach(i=>{l[i.roleId]||(l[i.roleId]=[]),l[i.roleId].push(i)});const d=[],p=[];if(Object.entries(l).forEach(([i,u])=>{if(u.length>1){const g=u.sort((m,c)=>{const h=m.assignedAt?.seconds||0;return(c.assignedAt?.seconds||0)-h});d.push(g[0]),p.push(...g.slice(1)),console.log(`  - Keeping latest ${i}, removing ${g.length-1} duplicates`)}else d.push(u[0])}),d.length>1){const i={owner:0,admin:1,verified_user:2,unverified_user:3,guest:4},u=d.reduce((g,m)=>{const c=i[g.roleId]||999;return(i[m.roleId]||999)<c?m:g});p.push(...d.filter(g=>g.id!==u.id)),console.log(`  - Keeping highest priority role: ${u.roleId}`)}for(const i of p)await P(j(w,S,i.id)),t++,console.log(`üóëÔ∏è Removed duplicate/excess role ${i.roleId} for user ${r}`)}return console.log(`üéâ Cleanup completed - removed ${t} duplicate roles`),t}catch(s){throw console.error("Error cleaning up roles:",s),s}};async function se({email:s,password:e,nickname:t}){try{const r=await W(y,s,e);return t&&await K(r.user,{displayName:t}),{ok:!0}}catch(r){const n={"auth/email-already-in-use":"This email is already registered.","auth/invalid-email":"Invalid email address.","auth/weak-password":"Password should be at least 6 characters."};throw new Error(n[r.code]||r.message)}}async function oe({email:s,password:e}){try{const r=(await G(y,s,e)).user;return{token:await r.getIdToken(),user:{email:r.email,nickname:r.displayName||r.email.split("@")[0]}}}catch(t){const r={"auth/user-not-found":"Invalid email or password.","auth/wrong-password":"Invalid email or password.","auth/invalid-email":"Invalid email address.","auth/user-disabled":"This account has been disabled.","auth/invalid-credential":"Invalid email or password."};throw new Error(r[t.code]||t.message)}}async function te(){try{return await Y(y),{ok:!0}}catch(s){throw new Error(s.message)}}async function ne(s=null){try{const e=s||y.currentUser;if(!e)throw new Error("No user is currently signed in.");return await B(e),{ok:!0}}catch(e){const t={"auth/too-many-requests":"Too many requests. Please try again later.","auth/user-not-found":"User not found."};throw new Error(t[e.code]||e.message)}}async function ie(s){try{return await z(y,s),{ok:!0}}catch(e){const t={"auth/user-not-found":"No account found with this email address.","auth/invalid-email":"Invalid email address.","auth/too-many-requests":"Too many requests. Please try again later."};throw new Error(t[e.code]||e.message)}}function be(){return y.currentUser?.emailVerified||!1}async function je(){y.currentUser&&await y.currentUser.reload()}function Se({children:s}){const[{token:e,user:t},r]=a.useState({token:null,user:null}),[n,l]=a.useState(!0),d=!!e;a.useEffect(()=>{const m=H(y,async c=>{if(c)try{const h=await c.getIdToken();r({token:h,user:{email:c.email,nickname:c.displayName||c.email.split("@")[0],emailVerified:c.emailVerified}});try{await I(j(w,"userInfo",c.uid),{email:c.email,nickname:c.displayName||c.email.split("@")[0],lastLogin:new Date,emailVerified:c.emailVerified},{merge:!0})}catch(E){console.warn("Could not save user info (this is okay during setup):",E)}}catch(h){console.error("Error getting token:",h),r({token:null,user:null})}else r({token:null,user:null});l(!1)});return()=>m()},[]);const p=async m=>{const c=await oe(m);r({token:c.token,user:c.user})},i=async m=>{await se(m)},u=async()=>{await te(),r({token:null,user:null})},g=a.useMemo(()=>({isLoggedIn:d,token:e||null,user:t||null,login:p,register:i,logout:u,loading:n}),[d,e,t,n]);return n?o.jsx("div",{style:{padding:"2rem",textAlign:"center"},children:"Loading..."}):o.jsx(A.Provider,{value:g,children:s})}function ae(){const s=a.useContext(A),e=U(),[t,r]=a.useState(""),[n,l]=a.useState(""),[d,p]=a.useState(""),[i,u]=a.useState(""),[g,m]=a.useState(!1),[c,h]=a.useState(!1),E=async v=>{v.preventDefault(),u(""),m(!1),h(!0);try{await s.register({email:t,password:d,nickname:n});try{await ne()}catch(C){console.warn("Failed to send verification email:",C)}m(!0),setTimeout(()=>e("/login"),600)}catch(C){u(C.message||"Sign-up failed.")}finally{h(!1)}};return o.jsxs("form",{onSubmit:E,style:{maxWidth:800,padding:"1rem"},children:[o.jsx("h1",{children:"Create account"}),g&&o.jsx("div",{style:{color:"green",marginBottom:8},children:"Registration successful. Redirecting to sign-in‚Ä¶"}),i&&o.jsx("div",{style:{color:"crimson",marginBottom:8},children:i}),o.jsxs("div",{style:{marginBottom:8},children:[o.jsx("label",{children:"Email"}),o.jsx("br",{}),o.jsx("input",{type:"email",value:t,onChange:v=>r(v.target.value),required:!0})]}),o.jsxs("div",{style:{marginBottom:8},children:[o.jsx("label",{children:"Nickname (optional)"}),o.jsx("br",{}),o.jsx("input",{value:n,onChange:v=>l(v.target.value)})]}),o.jsxs("div",{style:{marginBottom:8},children:[o.jsx("label",{children:"Password"}),o.jsx("br",{}),o.jsx("input",{type:"password",value:d,onChange:v=>p(v.target.value),required:!0})]}),o.jsx("button",{type:"submit",disabled:c,children:c?"Submitting...":"Sign up"}),o.jsxs("div",{style:{marginTop:8},children:["Already have an account? ",o.jsx(x,{to:"/login",children:"Sign in"})]})]})}const Re=Object.freeze(Object.defineProperty({__proto__:null,default:ae},Symbol.toStringTag,{value:"Module"}));function le(){const s=a.useContext(A),e=U(),r=J().state?.from?.pathname||"/",[n,l]=a.useState(""),[d,p]=a.useState(""),[i,u]=a.useState(""),[g,m]=a.useState(!1);if(s?.isLoggedIn)return o.jsxs("div",{style:{maxWidth:800,padding:"1rem"},children:[o.jsx("h1",{children:"Already signed in"}),o.jsxs("p",{children:["Go to ",o.jsx(x,{to:"/",children:"Home"})," or ",o.jsx(x,{to:"/logout",children:"Sign out"}),"."]})]});const c=async h=>{h.preventDefault(),u(""),m(!0);try{await s.login({email:n,password:d}),e(r,{replace:!0})}catch(E){u(E.message||"Sign-in failed.")}finally{m(!1)}};return o.jsxs("form",{onSubmit:c,style:{maxWidth:800,padding:"1rem"},children:[o.jsx("h1",{children:"Sign in"}),i&&o.jsx("div",{style:{color:"crimson",marginBottom:8},children:i}),o.jsxs("div",{style:{marginBottom:8},children:[o.jsx("label",{children:"Email"}),o.jsx("br",{}),o.jsx("input",{type:"email",value:n,onChange:h=>l(h.target.value),required:!0})]}),o.jsxs("div",{style:{marginBottom:8},children:[o.jsx("label",{children:"Password"}),o.jsx("br",{}),o.jsx("input",{type:"password",value:d,onChange:h=>p(h.target.value),required:!0})]}),o.jsx("div",{style:{marginBottom:12},children:o.jsx(x,{to:"/forgot-password",style:{fontSize:14},children:"Forgot password?"})}),o.jsx("button",{type:"submit",disabled:g,children:g?"Signing in...":"Sign in"}),o.jsxs("div",{style:{marginTop:8},children:["New user? ",o.jsx(x,{to:"/register",children:"Create an account"})]})]})}const ke=Object.freeze(Object.defineProperty({__proto__:null,default:le},Symbol.toStringTag,{value:"Module"}));function ce(){const s=a.useContext(A),[e,t]=a.useState(!1),r=U();return a.useEffect(()=>{s.logout().then(()=>t(!0))},[]),o.jsxs("div",{style:{maxWidth:800,padding:"1rem"},children:[o.jsx("h1",{children:"Sign out"}),o.jsx("div",{style:{marginTop:8},children:e?o.jsxs(o.Fragment,{children:[o.jsx("div",{style:{color:"green"},children:"You have been signed out."}),o.jsxs("div",{style:{marginTop:8},children:[o.jsx("button",{onClick:()=>r("/"),children:"Go to Home"}),o.jsx("span",{style:{marginLeft:8},children:o.jsx(x,{to:"/login",children:"Sign in again"})})]})]}):"Signing out‚Ä¶"})]})}const Ie=Object.freeze(Object.defineProperty({__proto__:null,default:ce},Symbol.toStringTag,{value:"Module"}));function de(){const[s,e]=a.useState(""),[t,r]=a.useState(""),[n,l]=a.useState(!1),[d,p]=a.useState(!1),i=async u=>{u.preventDefault(),r(""),l(!1),p(!0);try{await ie(s),l(!0),e("")}catch(g){r(g.message||"Failed to send reset email.")}finally{p(!1)}};return o.jsxs("div",{style:{maxWidth:420,padding:"1rem"},children:[o.jsx("h3",{children:"Reset Password"}),o.jsx("p",{style:{color:"#666",marginBottom:"1rem"},children:"Enter your email address and we'll send you a link to reset your password."}),n&&o.jsxs("div",{style:{color:"green",marginBottom:16,padding:12,backgroundColor:"#d4edda",border:"1px solid #c3e6cb",borderRadius:4},children:[o.jsx("strong",{children:"‚úì Email sent!"}),o.jsx("p",{style:{margin:"8px 0 0 0"},children:"Check your inbox for password reset instructions. The link will expire in 1 hour."})]}),t&&o.jsx("div",{style:{color:"crimson",marginBottom:16,padding:12,backgroundColor:"#f8d7da",border:"1px solid #f5c6cb",borderRadius:4},children:t}),o.jsxs("form",{onSubmit:i,children:[o.jsxs("div",{style:{marginBottom:16},children:[o.jsx("label",{htmlFor:"email",style:{display:"block",marginBottom:4},children:"Email Address"}),o.jsx("input",{id:"email",type:"email",value:s,onChange:u=>e(u.target.value),required:!0,placeholder:"your@email.com",style:{width:"100%",padding:8,fontSize:16,border:"1px solid #ccc",borderRadius:4}})]}),o.jsx("button",{type:"submit",disabled:d,style:{padding:"10px 20px",fontSize:16,backgroundColor:d?"#ccc":"#007bff",color:"white",border:"none",borderRadius:4,cursor:d?"not-allowed":"pointer",width:"100%"},children:d?"Sending...":"Send Reset Link"})]}),o.jsx("div",{style:{marginTop:16,textAlign:"center"},children:o.jsx(x,{to:"/login",children:"‚Üê Back to Sign In"})}),o.jsxs("div",{style:{marginTop:24,padding:12,backgroundColor:"#e7f3ff",border:"1px solid #b3d9ff",borderRadius:4,fontSize:14},children:[o.jsx("strong",{children:"üí° Note:"}),o.jsxs("ul",{style:{margin:"8px 0 0 0",paddingLeft:20},children:[o.jsx("li",{children:"Check your spam folder if you don't see the email"}),o.jsx("li",{children:"The reset link expires in 1 hour"}),o.jsx("li",{children:"You can request a new link if needed"})]})]})]})}const Ae=Object.freeze(Object.defineProperty({__proto__:null,default:de},Symbol.toStringTag,{value:"Module"}));export{Se as A,Ae as F,A as L,f as R,y as a,ye as b,pe as c,w as d,be as e,Z as f,_ as g,fe as h,we as i,Ee as j,b as k,re as l,he as m,xe as n,ee as o,M as p,ve as q,je as r,ne as s,Re as t,ke as u,Ie as v};
