import{j as e,b as W,A as I,R as v,c as d,a as U,C,F as x,h as H,B as L,D as j,M as f}from"./vendor-bootstrap-D2eqalZl.js";import{r as t}from"./vendor-router-CUyV5JBb.js";import{b as A,c as B}from"./vendor-firebase-CYcY3q11.js";import{d as $,a as w,f as Y,j as q}from"./auth-DdQ2LLef.js";import"./vendor-react-Bzgz95E1.js";function X(){const[b,y]=t.useState([]),[D,R]=t.useState(!0),[N,i]=t.useState(""),[S,u]=t.useState(""),[o,k]=t.useState(null),[p,M]=t.useState("unverified_user"),[O,g]=t.useState(!1),[_,E]=t.useState(!1);t.useEffect(()=>{h()},[]);const h=async()=>{try{R(!0);const s=await A(B($,"userRoles")),r={};s.forEach(n=>{const a=n.data();r[a.userId]||(r[a.userId]=[]),r[a.userId].push(a.roleId)});let l={};try{(await A(B($,"userInfo"))).forEach(a=>{const m=a.data();l[a.id]=m})}catch(n){console.warn("Could not load userInfo collection:",n)}const c=Object.entries(r).map(([n,a])=>{const m=l[n];return{id:n,email:m?.email||(n===w.currentUser?.uid?w.currentUser?.email:n),nickname:m?.nickname||m?.email?.split("@")[0]||n.slice(0,8),roles:a,isCurrentUser:n===w.currentUser?.uid}});y(c)}catch(s){i(`Failed to load users: ${s.message}`),console.error("Error fetching users:",s)}finally{R(!1)}},T=async()=>{if(o)try{if(i(""),u(""),o.isCurrentUser&&p!=="owner"){i("You cannot change your own role from Owner");return}await Y(o.id,p,w.currentUser?.uid),u(`Successfully changed ${o.email}'s role to ${p}`),g(!1),k(null),setTimeout(h,1e3)}catch(s){i(`Failed to change role: ${s.message}`)}},V=async()=>{try{E(!0),i(""),u("");const s=await q();u(`Successfully cleaned up ${s} duplicate roles`),await h()}catch(s){i(`Failed to cleanup roles: ${s.message}`)}finally{E(!1)}},G=(s,r)=>{const l={owner:"danger",admin:"warning",verified_user:"success",unverified_user:"info",guest:"light"},c={owner:"Owner",admin:"Admin",verified_user:"Verified User",unverified_user:"Unverified User",guest:"Guest"};return e.jsx(L,{bg:l[s]||"secondary",className:"me-1",children:c[s]||s},r)};if(D)return e.jsx("div",{className:"text-center p-4",children:"Loading users..."});const F={};return e.jsxs(W,{fluid:!0,style:{maxWidth:"1400px",padding:"2rem 1rem"},children:[N&&e.jsx(I,{variant:"danger",onClose:()=>i(""),dismissible:!0,children:N}),S&&e.jsx(I,{variant:"success",onClose:()=>u(""),dismissible:!0,children:S}),e.jsx(v,{className:"mb-4",children:e.jsx(d,{children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"mb-1",children:"Role Management"}),e.jsx("p",{className:"text-muted mb-0",children:"Manage user roles and related actions"})]}),e.jsx(U,{variant:"primary",onClick:V,disabled:_,children:_?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-1"}),"Cleaning..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"bi bi-arrow-clockwise me-2"}),"Cleanup Roles"]})})]})})}),e.jsx(v,{className:"mb-4",children:e.jsx(d,{children:e.jsx(C,{style:F,children:e.jsx(C.Body,{children:e.jsxs(v,{className:"g-3",children:[e.jsx(d,{md:3,children:e.jsxs(x.Select,{onChange:s=>{const r=s.target.value;r==="all"?h():y(l=>l.filter(c=>(c.roles||[]).includes(r)))},defaultValue:"all",children:[e.jsx("option",{value:"all",children:"All Roles"}),e.jsx("option",{value:"owner",children:"Owner"}),e.jsx("option",{value:"admin",children:"Admin"}),e.jsx("option",{value:"verified_user",children:"Verified User"}),e.jsx("option",{value:"unverified_user",children:"Unverified User"}),e.jsx("option",{value:"guest",children:"Guest"})]})}),e.jsx(d,{md:3,children:e.jsx(x.Control,{type:"text",placeholder:"Search by email",onChange:s=>{const r=s.target.value.trim().toLowerCase();if(!r){h();return}y(l=>l.filter(c=>(c.email||"").toLowerCase().includes(r)))}})}),e.jsx(d,{md:6})]})})})})}),e.jsx(v,{children:e.jsx(d,{children:e.jsx(C,{style:F,children:e.jsx(C.Body,{children:e.jsxs(H,{responsive:!0,hover:!0,className:"mb-0",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"User"}),e.jsx("th",{children:"Current Roles"}),e.jsx("th",{style:{width:"160px"},className:"text-end",children:"Actions"})]})}),e.jsx("tbody",{children:b.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:"3",className:"text-center text-muted",children:"No users with roles found"})}):b.map(s=>e.jsxs("tr",{children:[e.jsxs("td",{children:[e.jsxs("div",{children:[e.jsx("strong",{children:s.email}),s.nickname&&s.nickname!==s.email?.split("@")[0]&&e.jsx("div",{children:e.jsxs("small",{className:"text-muted",children:["(",s.nickname,")"]})}),e.jsx("div",{children:e.jsxs("small",{className:"text-muted font-monospace",children:["ID: ",s.id]})})]}),s.isCurrentUser&&e.jsx(L,{bg:"primary",className:"ms-2",children:"You"})]}),e.jsx("td",{children:s.roles.map((r,l)=>G(r,l))}),e.jsx("td",{className:"text-end",children:e.jsxs(j,{children:[e.jsx(j.Toggle,{variant:"outline-secondary",size:"sm",children:"Actions"}),e.jsxs(j.Menu,{align:"end",children:[e.jsx(j.Item,{onClick:()=>{k(s),M(s.roles[0]||"unverified_user"),g(!0)},disabled:s.isCurrentUser,children:"Change Role"}),e.jsx(j.Item,{disabled:!0,className:s.isCurrentUser?"":"d-none",children:"Current User"})]})]})})]},s.id))})]})})})})}),e.jsxs(f,{show:O,onHide:()=>g(!1),children:[e.jsx(f.Header,{closeButton:!0,children:e.jsx(f.Title,{children:"Change User Role"})}),e.jsxs(f.Body,{children:[e.jsxs("p",{children:["Change role for: ",e.jsx("strong",{children:o?.email})]}),e.jsx("p",{className:"text-muted small",children:"Users must have exactly one role. Changing the role will replace the current role."}),e.jsxs(x.Group,{children:[e.jsx(x.Label,{children:"New Role"}),e.jsxs(x.Select,{value:p,onChange:s=>M(s.target.value),children:[e.jsx("option",{value:"verified_user",children:"Verified User (Level 2) - Can comment and like"}),e.jsx("option",{value:"unverified_user",children:"Unverified User (Level 3) - Can only read and like"}),e.jsx("option",{value:"admin",children:"Admin (Level 1) - Can manage articles"}),o?.isCurrentUser&&e.jsx("option",{value:"owner",children:"Owner (Level 0) - Full system access"})]})]})]}),e.jsxs(f.Footer,{children:[e.jsx(U,{variant:"secondary",onClick:()=>g(!1),children:"Cancel"}),e.jsx(U,{variant:"primary",onClick:T,children:"Update Role"})]})]})]})}export{X as default};
